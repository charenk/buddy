<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Figma AI Buddy - Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
        }

        .stat-card .label {
            color: #999;
            font-size: 0.9rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .context-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .context-panel h2 {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 25px;
            color: #333;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .form-group select,
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group select:focus,
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .checkbox-item label {
            margin: 0;
            font-weight: 500;
            cursor: pointer;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .usage-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .usage-panel h2 {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 25px;
            color: #333;
        }

        .usage-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #e1e5e9;
        }

        .usage-item:last-child {
            border-bottom: none;
        }

        .usage-item .label {
            font-weight: 500;
            color: #333;
        }

        .usage-item .value {
            font-weight: 600;
            color: #667eea;
        }

        .trial-warning {
            background: linear-gradient(135deg, #ff9a9e, #fecfef);
            color: #333;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            text-align: center;
        }

        .trial-warning h3 {
            margin-bottom: 10px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎨 Figma AI Buddy</h1>
            <p>Customize how your AI design critic responds to your Figma comments</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <h3>Trial Uses</h3>
                <div class="value" id="trial-remaining">-</div>
                <div class="label">remaining</div>
            </div>
            <div class="stat-card">
                <h3>Total Interactions</h3>
                <div class="value" id="total-interactions">-</div>
                <div class="label">this month</div>
            </div>
            <div class="stat-card">
                <h3>Cost</h3>
                <div class="value" id="total-cost">$0.00</div>
                <div class="label">this month</div>
            </div>
        </div>

        <div class="main-content">
            <div class="context-panel">
                <h2>Response Preferences</h2>
                
                <div class="success-message" id="success-message">
                    Settings saved successfully!
                </div>
                
                <div class="error-message" id="error-message">
                    Failed to save settings. Please try again.
                </div>

                <form id="context-form">
                    <div class="form-group">
                        <label for="length">Response Length</label>
                        <select id="length" name="length">
                            <option value="brief">Brief (2-3 points)</option>
                            <option value="detailed" selected>Detailed (5-7 points)</option>
                            <option value="comprehensive">Comprehensive (full analysis)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="tone">Response Tone</label>
                        <select id="tone" name="tone">
                            <option value="casual">Casual & Friendly</option>
                            <option value="professional" selected>Professional & Formal</option>
                            <option value="encouraging">Encouraging & Supportive</option>
                            <option value="critical">Critical & Direct</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Focus Areas</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="focus-ux" name="focus" value="ux" checked>
                                <label for="focus-ux">User Experience</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="focus-visual" name="focus" value="visual" checked>
                                <label for="focus-visual">Visual Design</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="focus-accessibility" name="focus" value="accessibility">
                                <label for="focus-accessibility">Accessibility</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="focus-performance" name="focus" value="performance">
                                <label for="focus-performance">Performance</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="focus-content" name="focus" value="content">
                                <label for="focus-content">Content</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="focus-interaction" name="focus" value="interaction">
                                <label for="focus-interaction">Interactions</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="domain">Domain Expertise</label>
                        <select id="domain" name="domain">
                            <option value="general">General Design</option>
                            <option value="mobile_apps">Mobile Apps</option>
                            <option value="web_apps">Web Applications</option>
                            <option value="enterprise">Enterprise Software</option>
                            <option value="ecommerce">E-commerce</option>
                            <option value="saas">SaaS Products</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="language">Language</label>
                        <select id="language" name="language">
                            <option value="en" selected>English</option>
                            <option value="es">Spanish</option>
                            <option value="fr">French</option>
                            <option value="de">German</option>
                            <option value="ja">Japanese</option>
                            <option value="ko">Korean</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="custom-instructions">Custom Instructions (Optional)</label>
                        <textarea 
                            id="custom-instructions" 
                            name="custom_instructions" 
                            rows="4" 
                            placeholder="Add any specific instructions for how you want the AI to respond..."
                        ></textarea>
                    </div>

                    <button type="submit" class="btn">Save Preferences</button>
                </form>
            </div>

            <div class="usage-panel">
                <h2>Usage & Settings</h2>
                
                <div class="trial-warning" id="trial-warning" style="display: none;">
                    <h3>⚠️ Trial Almost Complete</h3>
                    <p>You have <span id="trial-count">0</span> free uses remaining. Add your OpenAI API key to continue using @buddy.</p>
                </div>

                <div class="usage-item">
                    <span class="label">Subscription Status</span>
                    <span class="value" id="subscription-status">Trial</span>
                </div>

                <div class="usage-item">
                    <span class="label">API Key Status</span>
                    <span class="value" id="api-key-status">Not Set</span>
                </div>

                <div class="usage-item">
                    <span class="label">Last Active</span>
                    <span class="value" id="last-active">-</span>
                </div>

                <div class="usage-item">
                    <span class="label">Figma Handle</span>
                    <span class="value" id="figma-handle">-</span>
                </div>

                <div style="margin-top: 30px;">
                    <h3 style="margin-bottom: 15px;">API Key Management</h3>
                    <div class="form-group">
                        <label for="openai-key">OpenAI API Key</label>
                        <input 
                            type="password" 
                            id="openai-key" 
                            name="openai_key" 
                            placeholder="sk-..."
                        >
                        <small style="color: #666; margin-top: 5px; display: block;">
                            Your API key is encrypted and stored securely. You only pay for your own usage.
                        </small>
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="saveApiKey()">Save API Key</button>
                </div>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Loading...</p>
        </div>
    </div>

    <script>
        // Global state
        let currentUser = null;
        let currentContext = null;

        // Initialize dashboard
        async function initDashboard() {
            showLoading(true);
            
            try {
                // Get user ID from URL or localStorage
                const userId = getUserId();
                if (!userId) {
                    // Create a test user automatically instead of redirecting
                    console.log('No user ID found, creating test user...');
                    await loadUserData(null);
                    return;
                }

                // Load user data and context
                await loadUserData(userId);
                await loadUserContext(userId);
                
            } catch (error) {
                console.error('Error initializing dashboard:', error);
                showError('Failed to load dashboard data');
            } finally {
                showLoading(false);
            }
        }

        // Get user ID from URL or localStorage
        function getUserId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('userId') || localStorage.getItem('userId');
        }

        // Load user data
        async function loadUserData(userId) {
            try {
                // For now, create a test user if none exists
                if (!userId) {
                    const response = await fetch('/api/auth/working-signup', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            action: 'create',
                            email: 'test@example.com',
                            figma_handle: 'testuser',
                            figma_user_id: 'test123'
                        })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        currentUser = data.dashboard;
                        localStorage.setItem('userId', data.user.id);
                        updateUserStats();
                        return;
                    }
                }
                
                // If we have a userId, try to load context
                const response = await fetch(`/api/context/get?userId=${userId}`);
                const data = await response.json();
                
                if (data.success) {
                    currentUser = data.dashboard;
                    updateUserStats();
                } else {
                    throw new Error(data.error || 'Failed to load user data');
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                throw error;
            }
        }

        // Load user context
        async function loadUserContext(userId) {
            try {
                const response = await fetch(`/api/context/get?userId=${userId}`);
                const data = await response.json();
                
                if (data.success) {
                    currentContext = data.context;
                    populateContextForm();
                } else {
                    throw new Error(data.error || 'Failed to load context');
                }
            } catch (error) {
                console.error('Error loading context:', error);
                throw error;
            }
        }

        // Update user stats display
        function updateUserStats() {
            if (!currentUser) return;

            document.getElementById('trial-remaining').textContent = currentUser.stats?.trial_remaining || 0;
            document.getElementById('total-interactions').textContent = currentUser.stats?.total_interactions || 0;
            document.getElementById('total-cost').textContent = `$${((currentUser.stats?.total_cost_cents || 0) / 100).toFixed(2)}`;
            document.getElementById('subscription-status').textContent = currentUser.user?.subscription_status || 'Trial';
            document.getElementById('figma-handle').textContent = currentUser.user?.figma_handle || '-';
            document.getElementById('last-active').textContent = currentUser.user?.last_active_at ? 
                new Date(currentUser.user.last_active_at).toLocaleDateString() : '-';
            document.getElementById('api-key-status').textContent = currentUser.user?.api_key_encrypted ? 'Set' : 'Not Set';

            // Show trial warning if needed
            const trialRemaining = currentUser.stats?.trial_remaining || 0;
            if (trialRemaining <= 3) {
                document.getElementById('trial-warning').style.display = 'block';
                document.getElementById('trial-count').textContent = trialRemaining;
            }
        }

        // Populate context form
        function populateContextForm() {
            if (!currentContext) return;

            const style = currentContext.response_style;
            
            // Set form values
            document.getElementById('length').value = style.length || 'detailed';
            document.getElementById('tone').value = style.tone || 'professional';
            document.getElementById('domain').value = style.domain || 'general';
            document.getElementById('language').value = style.language || 'en';
            
            // Set focus areas
            const focusCheckboxes = document.querySelectorAll('input[name="focus"]');
            focusCheckboxes.forEach(checkbox => {
                checkbox.checked = style.focus?.includes(checkbox.value) || false;
            });

            // Set custom instructions
            if (currentContext.custom_prompts?.focusInstructions) {
                document.getElementById('custom-instructions').value = currentContext.custom_prompts.focusInstructions;
            }
        }

        // Save context
        async function saveContext() {
            const userId = getUserId();
            if (!userId) return;

            const formData = new FormData(document.getElementById('context-form'));
            const context = {
                length: formData.get('length'),
                tone: formData.get('tone'),
                focus: Array.from(formData.getAll('focus')),
                domain: formData.get('domain'),
                language: formData.get('language'),
                custom_prompts: {
                    focusInstructions: formData.get('custom_instructions') || ''
                }
            };

            try {
                const response = await fetch('/api/context/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId,
                        context
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showSuccess('Settings saved successfully!');
                    currentContext = data.context;
                    
                    // Save to localStorage for persistence
                    localStorage.setItem('buddyContext', JSON.stringify(context));
                    localStorage.setItem('buddyUserId', userId);
                } else {
                    throw new Error(data.error || 'Failed to save settings');
                }
            } catch (error) {
                console.error('Error saving context:', error);
                showError('Failed to save settings. Please try again.');
            }
        }

        // Save API key
        async function saveApiKey() {
            const userId = getUserId();
            if (!userId) return;

            const apiKey = document.getElementById('openai-key').value;
            if (!apiKey) {
                showError('Please enter your OpenAI API key');
                return;
            }

            try {
                const response = await fetch('/api/auth/working-signup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'update-api-key',
                        userId,
                        apiKey
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    showSuccess('API key saved successfully!');
                    document.getElementById('api-key-status').textContent = 'Set';
                    document.getElementById('openai-key').value = '';
                } else {
                    throw new Error(data.error || 'Failed to save API key');
                }
            } catch (error) {
                console.error('Error saving API key:', error);
                showError('Failed to save API key. Please try again.');
            }
        }

        // Utility functions
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function showSuccess(message) {
            const successEl = document.getElementById('success-message');
            successEl.textContent = message;
            successEl.style.display = 'block';
            setTimeout(() => {
                successEl.style.display = 'none';
            }, 3000);
        }

        function showError(message) {
            const errorEl = document.getElementById('error-message');
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            setTimeout(() => {
                errorEl.style.display = 'none';
            }, 5000);
        }

        // Event listeners
        document.getElementById('context-form').addEventListener('submit', (e) => {
            e.preventDefault();
            saveContext();
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>