<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Design System & Accessibility Audit</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8f9fa;
      color: #333;
    }

    .container {
      padding: 20px;
      max-width: 450px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .logo {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 12px;
      margin: 0 auto 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }

    .title {
      font-size: 24px;
      font-weight: 700;
      color: #1a1a1a;
      margin-bottom: 8px;
    }

    .subtitle {
      font-size: 14px;
      color: #666;
    }

    .section {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #1a1a1a;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 8px;
      color: #333;
    }

    .form-input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .form-textarea {
      min-height: 80px;
      resize: vertical;
    }

    .form-select {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      background: white;
    }

    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
      width: 100%;
      margin-bottom: 8px;
    }

    .btn:hover {
      transform: translateY(-1px);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: #6c757d;
    }

    .btn-success {
      background: #28a745;
    }

    .btn-warning {
      background: #ffc107;
      color: #212529;
    }

    .btn-danger {
      background: #dc3545;
    }

    .btn-group {
      display: flex;
      gap: 8px;
    }

    .btn-group .btn {
      flex: 1;
      margin-bottom: 0;
    }

    .status {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
      text-align: center;
      font-weight: 500;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status.warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .message {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
    }

    .message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .message.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .config-summary {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 16px;
    }

    .config-summary h4 {
      margin-bottom: 8px;
      color: #495057;
    }

    .config-summary p {
      margin: 4px 0;
      font-size: 13px;
      color: #6c757d;
    }

    .audit-results {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 16px;
    }

    .audit-results h4 {
      margin-bottom: 8px;
      color: #495057;
    }

    .audit-results .summary {
      display: flex;
      justify-content: space-between;
      margin: 4px 0;
      font-size: 13px;
    }

    .audit-results .summary .label {
      color: #6c757d;
    }

    .audit-results .summary .value {
      font-weight: 500;
      color: #495057;
    }

    .hidden {
      display: none;
    }

    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .tabs {
      display: flex;
      margin-bottom: 20px;
      background: white;
      border-radius: 8px;
      padding: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .tab.active {
      background: #667eea;
      color: white;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">üîç</div>
      <h1 class="title">Design System & Accessibility Audit</h1>
      <p class="subtitle">Audit your designs for consistency and accessibility</p>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <div class="tab active" data-tab="config">Configuration</div>
      <div class="tab" data-tab="audit">Audit</div>
    </div>

    <!-- Configuration Tab -->
    <div id="config-tab" class="tab-content active">
      <div class="section">
        <h2 class="section-title">Design System Configuration</h2>
        
        <div class="form-group">
          <label class="form-label">Team ID</label>
          <input type="text" id="team-id" class="form-input" placeholder="Enter your team ID (e.g., team-123)" />
        </div>

        <div class="form-group">
          <label class="form-label">Design System URL (Optional)</label>
          <input type="url" id="design-system-url" class="form-input" placeholder="https://chakra-ui.com/docs/components/concepts/overview" />
          <small style="color: #6c757d; font-size: 12px; margin-top: 4px; display: block;">
            Supported: Chakra UI, Material UI, Ant Design, Mantine, Headless UI
          </small>
        </div>

        <div class="form-group">
          <label class="form-label">Custom Design Guidelines (Optional)</label>
          <textarea id="design-system-text" class="form-input form-textarea" placeholder="Enter your custom design system guidelines, principles, or rules..."></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Accessibility Level</label>
          <select id="accessibility-level" class="form-select">
            <option value="AA">WCAG 2.1 Level AA (Recommended)</option>
            <option value="A">WCAG 2.1 Level A (Minimum)</option>
            <option value="AAA">WCAG 2.1 Level AAA (Enhanced)</option>
          </select>
        </div>

        <button id="save-config" class="btn">Save Configuration</button>
        <button id="load-config" class="btn btn-secondary">Load Configuration</button>
      </div>

      <div id="config-summary" class="config-summary hidden">
        <h4>Current Configuration</h4>
        <p id="config-details"></p>
      </div>
    </div>

    <!-- Audit Tab -->
    <div id="audit-tab" class="tab-content">
      <div class="section">
        <h2 class="section-title">Run Audit</h2>
        
        <div id="audit-status" class="status info">
          Select a frame and choose an audit type to begin.
        </div>

        <div class="btn-group">
          <button id="audit-accessibility" class="btn btn-warning">‚ôø Accessibility</button>
          <button id="audit-design-system" class="btn btn-success">üéØ Design System</button>
        </div>
        
        <button id="audit-both" class="btn">üîç Both Audits</button>
      </div>

      <div id="audit-results" class="audit-results hidden">
        <h4>Audit Results</h4>
        <div id="audit-summary"></div>
      </div>
    </div>

    <button id="close-btn" class="btn btn-secondary">Close Plugin</button>

    <div id="message-container"></div>
  </div>

  <script>
    let currentConfig = null;
    let currentTeamId = null;

    // Initialize plugin
    function initPlugin() {
      showMessage('Plugin loaded! Configure your design system and run audits.', 'info');
      
      // Tab switching
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => switchTab(tab.dataset.tab));
      });
      
      // Configuration handlers
      document.getElementById('save-config').addEventListener('click', saveConfiguration);
      document.getElementById('load-config').addEventListener('click', loadConfiguration);
      
      // Audit handlers
      document.getElementById('audit-accessibility').addEventListener('click', () => runAudit('accessibility'));
      document.getElementById('audit-design-system').addEventListener('click', () => runAudit('design-system'));
      document.getElementById('audit-both').addEventListener('click', () => runAudit('both'));
      
      // Close button
      document.getElementById('close-btn').addEventListener('click', closePlugin);
      
      // Load configuration on startup
      loadConfiguration();
    }

    // Switch between tabs
    function switchTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
      
      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(`${tabName}-tab`).classList.add('active');
    }

    // Save configuration
    async function saveConfiguration() {
      const teamId = document.getElementById('team-id').value.trim();
      const designSystemUrl = document.getElementById('design-system-url').value.trim();
      const designSystemText = document.getElementById('design-system-text').value.trim();
      const accessibilityLevel = document.getElementById('accessibility-level').value;

      if (!teamId) {
        showMessage('Please enter a Team ID', 'error');
        return;
      }

      if (!designSystemUrl && !designSystemText) {
        showMessage('Please provide either a Design System URL or custom guidelines', 'error');
        return;
      }

      const saveBtn = document.getElementById('save-config');
      const originalText = saveBtn.textContent;
      
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<span class="loading"></span> Saving...';

      try {
        const response = await fetch('https://buddy-fz1y2s7ml-charenkoneti-cyberqpcoms-projects.vercel.app/api/config?action=save', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            teamId: teamId,
            designSystemUrl: designSystemUrl || null,
            designSystemText: designSystemText || null,
            accessibilityLevel: accessibilityLevel
          })
        });

        if (!response.ok) {
          const error = await response.text();
          throw new Error(error);
        }

        const result = await response.json();
        currentConfig = result.config;
        currentTeamId = teamId;
        
        showMessage('Configuration saved successfully!', 'success');
        updateConfigSummary(result.config);
        
      } catch (error) {
        showMessage('Failed to save configuration: ' + error.message, 'error');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = originalText;
      }
    }

    // Load configuration
    async function loadConfiguration() {
      const teamId = document.getElementById('team-id').value.trim();
      
      if (!teamId) {
        showMessage('Please enter a Team ID first', 'info');
        return;
      }

      const loadBtn = document.getElementById('load-config');
      const originalText = loadBtn.textContent;
      
      loadBtn.disabled = true;
      loadBtn.innerHTML = '<span class="loading"></span> Loading...';

      try {
        parent.postMessage({
          pluginMessage: {
            type: 'get-config',
            teamId: teamId
          }
        }, '*');
        
      } catch (error) {
        showMessage('Failed to load configuration: ' + error.message, 'error');
      } finally {
        loadBtn.disabled = false;
        loadBtn.textContent = originalText;
      }
    }

    // Run audit
    function runAudit(auditType) {
      if (!currentTeamId) {
        showMessage('Please configure your team settings first', 'error');
        switchTab('config');
        return;
      }

      const auditBtn = document.getElementById(`audit-${auditType}`);
      const originalText = auditBtn.textContent;
      
      auditBtn.disabled = true;
      auditBtn.innerHTML = '<span class="loading"></span> Auditing...';

      parent.postMessage({
        pluginMessage: {
          type: `audit-${auditType}`,
          teamId: currentTeamId,
          customRules: currentConfig?.customRules || []
        }
      }, '*');

      // Reset button after timeout
      setTimeout(() => {
        auditBtn.disabled = false;
        auditBtn.textContent = originalText;
      }, 10000);
    }

    // Update configuration summary
    function updateConfigSummary(config) {
      if (!config) return;

      const details = [];
      if (config.designSystemUrl) {
        details.push(`URL: ${config.designSystemUrl}`);
      }
      if (config.designSystemText) {
        details.push(`Custom Guidelines: ${config.designSystemText.substring(0, 50)}...`);
      }
      details.push(`Accessibility: WCAG ${config.accessibilityLevel}`);

      document.getElementById('config-details').innerHTML = details.join('<br>');
      document.getElementById('config-summary').classList.remove('hidden');
    }

    // Update audit results
    function updateAuditResults(summary, issueCount) {
      const summaryHtml = `
        <div class="summary">
          <span class="label">Total Issues:</span>
          <span class="value">${issueCount}</span>
        </div>
        <div class="summary">
          <span class="label">Errors:</span>
          <span class="value">${summary.errors || 0}</span>
        </div>
        <div class="summary">
          <span class="label">Warnings:</span>
          <span class="value">${summary.warnings || 0}</span>
        </div>
        <div class="summary">
          <span class="label">Info:</span>
          <span class="value">${summary.info || 0}</span>
        </div>
      `;

      document.getElementById('audit-summary').innerHTML = summaryHtml;
      document.getElementById('audit-results').classList.remove('hidden');
    }

    // Show message to user
    function showMessage(message, type = 'info') {
      const container = document.getElementById('message-container');
      const messageEl = document.createElement('div');
      messageEl.className = `message ${type}`;
      messageEl.textContent = message;
      container.innerHTML = '';
      container.appendChild(messageEl);
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        if (messageEl.parentNode) {
          messageEl.parentNode.removeChild(messageEl);
        }
      }, 5000);
    }

    // Close plugin
    function closePlugin() {
      parent.postMessage({ pluginMessage: { type: 'close-plugin' } }, '*');
    }

    // Handle messages from plugin code
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      
      if (msg.type === 'config-loaded') {
        currentConfig = msg.config;
        if (msg.config) {
          updateConfigSummary(msg.config);
          showMessage('Configuration loaded successfully!', 'success');
        } else {
          showMessage('No configuration found for this team', 'info');
        }
      } else if (msg.type === 'audit-complete') {
        updateAuditResults(msg.summary, msg.issueCount);
        showMessage(msg.message, 'success');
        document.getElementById('audit-status').textContent = `Audit complete! Found ${msg.issueCount} issues.`;
        document.getElementById('audit-status').className = 'status success';
      } else if (msg.type === 'error') {
        showMessage('‚ùå ' + msg.message, 'error');
        document.getElementById('audit-status').textContent = 'Audit failed. Please try again.';
        document.getElementById('audit-status').className = 'status error';
      }
    };

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', initPlugin);
  </script>
</body>
</html>