<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Figma AI Buddy</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8f9fa;
      color: #333;
    }

    .container {
      padding: 20px;
      max-width: 400px;
    }

    .header {
      text-align: center;
      margin-bottom: 20px;
    }

    .header h1 {
      font-size: 1.5rem;
      color: #667eea;
      margin-bottom: 5px;
    }

    .header p {
      color: #666;
      font-size: 0.9rem;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #555;
    }

    select, textarea, input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    .btn {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      width: 100%;
      margin: 5px 0;
    }

    .btn:hover {
      opacity: 0.9;
    }

    .btn-secondary {
      background: #6c757d;
    }

    .message {
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      font-size: 14px;
    }

    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .result {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 5px;
      margin: 15px 0;
      border-left: 4px solid #667eea;
    }

    .result h3 {
      margin-bottom: 10px;
      color: #333;
    }

    .result p {
      line-height: 1.5;
      white-space: pre-wrap;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }

    .hidden {
      display: none;
    }

    .settings-section {
      background: white;
      padding: 15px;
      border-radius: 5px;
      margin: 15px 0;
      border: 1px solid #e1e5e9;
    }

    .settings-section h3 {
      margin-bottom: 10px;
      color: #333;
    }

    .checkbox-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 5px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
    }

    .checkbox-item input {
      width: auto;
      margin-right: 5px;
    }

    .context-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 5px;
      font-size: 0.8rem;
    }

    .context-count {
      color: #666;
      font-weight: 600;
    }

    .context-tip {
      color: #667eea;
      font-style: italic;
    }

    .context-count.warning {
      color: #ff6b6b;
    }

    .context-count.error {
      color: #e74c3c;
      font-weight: bold;
    }

    .usage-instructions {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #007AFF;
    }

    .usage-instructions code {
      background: #e9ecef;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
      font-size: 0.9em;
    }

    .usage-instructions ol, .usage-instructions ul {
      margin: 10px 0;
      padding-left: 20px;
    }

    .usage-instructions li {
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>🎨 Figma AI Buddy</h1>
      <p>AI design assistant with account management</p>
    </div>

    <!-- Authentication Section -->
    <div id="auth-section" class="settings-section">
      <h3>Account Setup</h3>
      <div id="auth-status">
        <p>Please authenticate with Figma to enable comment-based AI responses.</p>
        <button id="auth-button" class="btn">Connect with Figma</button>
        <button id="test-auth-button" class="btn btn-secondary" style="margin-top: 10px;">Test Auth (Debug)</button>
      </div>
    </div>

    <!-- Webhook Management Section -->
    <div id="webhook-section" class="settings-section hidden">
      <h3>Webhook Management</h3>
      <div id="webhook-status">
        <p>Webhook status: <span id="webhook-status-text">Checking...</span></p>
        <button id="setup-webhook-btn" class="btn">Setup Webhook</button>
        <button id="delete-webhook-btn" class="btn btn-secondary">Delete Webhook</button>
      </div>
    </div>

    <!-- Usage Instructions Section -->
    <div id="usage-section" class="settings-section hidden">
      <h3>How to Use</h3>
      <div class="usage-instructions">
        <p><strong>Comment-based AI Analysis:</strong></p>
        <ol>
          <li>Comment on any frame or component in Figma</li>
          <li>Start your comment with <code>@buddy</code></li>
          <li>Add your analysis request (e.g., "analyze this design")</li>
          <li>Buddy will reply with AI analysis using your context!</li>
        </ol>
        <p><strong>Examples:</strong></p>
        <ul>
          <li><code>@buddy analyze this design</code></li>
          <li><code>@buddy check for accessibility issues</code></li>
          <li><code>@buddy review the user experience</code></li>
        </ul>
      </div>
    </div>

    <div id="status"></div>

    <!-- Context Management Section -->
    <div id="context-section" class="settings-section">
      <h3>Product Context</h3>
      
      <div class="form-group">
        <label for="context">Set your product/domain context (up to 1000 words):</label>
        <textarea id="context" placeholder="Describe your product, target audience, design system, brand guidelines, or any specific context that will help Buddy provide more relevant analysis..."></textarea>
        <div class="context-info">
          <span id="context-count">0/1000 words</span>
          <span class="context-tip">💡 This context will be remembered and used in all AI responses</span>
        </div>
      </div>
    </div>

    <!-- Analysis Settings Section -->
    <div id="settings-section" class="settings-section">
      <h3>Analysis Settings</h3>
      
      <div class="form-group">
        <label for="length">Response Length:</label>
        <select id="length">
          <option value="brief">Brief (2-3 points)</option>
          <option value="detailed" selected>Detailed (5-7 points)</option>
          <option value="comprehensive">Comprehensive (full analysis)</option>
        </select>
      </div>

      <div class="form-group">
        <label for="tone">Tone:</label>
        <select id="tone">
          <option value="casual">Casual & Friendly</option>
          <option value="professional" selected>Professional & Formal</option>
          <option value="encouraging">Encouraging & Supportive</option>
          <option value="critical">Critical & Direct</option>
        </select>
      </div>

      <div class="form-group">
        <label>Focus Areas:</label>
        <div class="checkbox-group">
          <div class="checkbox-item">
            <input type="checkbox" id="focus-ux" value="ux" checked>
            <label for="focus-ux">UX</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="focus-visual" value="visual" checked>
            <label for="focus-visual">Visual</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="focus-accessibility" value="accessibility">
            <label for="focus-accessibility">Accessibility</label>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="focus-performance" value="performance">
            <label for="focus-performance">Performance</label>
          </div>
        </div>
      </div>

      <div class="form-group">
        <div class="checkbox-item">
          <input type="checkbox" id="include-visual" checked>
          <label for="include-visual">Include Visual Analysis (analyze selected frames/components)</label>
        </div>
        <p style="font-size: 0.8rem; color: #666; margin-top: 5px;">
          When enabled, the AI will analyze the actual visual appearance of selected elements.
        </p>
      </div>

      <button type="button" id="save-settings-btn" class="btn">Save Settings</button>
    </div>


    <!-- Quick Actions -->
    <div style="margin-top: 20px;">
      <button type="button" class="btn btn-secondary" onclick="closePlugin()">Close Plugin</button>
    </div>
  </div>

  <script>
    const API_BASE = 'https://buddy-lac-five.vercel.app';
    let currentSettings = {};
    let userSession = null;
    let userContext = null;

    // Initialize plugin
    function initPlugin() {
      showMessage('Plugin loaded successfully!', 'success');
      
      // Load saved settings
      loadSettings();
      
      // Check authentication status
      checkAuthStatus();
    }

    // Check authentication status
    async function checkAuthStatus() {
      try {
        console.log('Checking auth status...');
        const savedSession = localStorage.getItem('buddySession');
        console.log('Saved session exists:', !!savedSession);
        
        if (savedSession) {
          try {
            userSession = JSON.parse(savedSession);
            console.log('User session:', userSession);
            
            // Check if session is still valid
            const now = Date.now();
            const expiresAt = userSession.expires_at;
            console.log('Session expires at:', new Date(expiresAt));
            console.log('Current time:', new Date(now));
            console.log('Session valid:', now < expiresAt);
            
            if (now < expiresAt) {
              console.log('Session is valid, showing authenticated state');
              showAuthenticatedState();
              await loadUserContext();
              await checkWebhookStatus();
            } else {
              console.log('Session expired, showing unauthenticated state');
              localStorage.removeItem('buddySession');
              showUnauthenticatedState();
            }
          } catch (parseError) {
            console.error('Failed to parse session:', parseError);
            localStorage.removeItem('buddySession');
            showUnauthenticatedState();
          }
        } else {
          console.log('No saved session, showing unauthenticated state');
          showUnauthenticatedState();
        }
      } catch (error) {
        console.error('Auth check failed:', error);
        showUnauthenticatedState();
      }
    }

    // Show authenticated state
    function showAuthenticatedState() {
      document.getElementById('auth-section').classList.add('hidden');
      document.getElementById('webhook-section').classList.remove('hidden');
      document.getElementById('usage-section').classList.remove('hidden');
      document.getElementById('context-section').classList.remove('hidden');
      document.getElementById('settings-section').classList.remove('hidden');
    }

    // Show unauthenticated state
    function showUnauthenticatedState() {
      document.getElementById('auth-section').classList.remove('hidden');
      document.getElementById('webhook-section').classList.add('hidden');
      document.getElementById('context-section').classList.add('hidden');
      document.getElementById('settings-section').classList.add('hidden');
    }

    // Handle authentication
    document.getElementById('auth-button').addEventListener('click', async () => {
      try {
        // First check if API is accessible
        showMessage('Checking API availability...', 'success');
        
        const testResponse = await fetch(`${API_BASE}/api/auth?action=figma-oauth`, {
          method: 'GET'
        });
        
        if (!testResponse.ok) {
          showMessage('❌ API not accessible. Please check deployment status.', 'error');
          return;
        }
        
        // Open OAuth flow in new window
        const authUrl = `${API_BASE}/api/auth?action=figma-oauth`;
        console.log('Opening auth URL:', authUrl);
        
        const authWindow = window.open(authUrl, 'figma-auth', 'width=500,height=600,scrollbars=yes,resizable=yes');
        
        if (!authWindow) {
          showMessage('Please allow popups for this site to authenticate', 'error');
          return;
        }
        
        // Listen for auth completion
        const checkAuth = setInterval(() => {
          try {
            if (authWindow.closed) {
              clearInterval(checkAuth);
              console.log('Auth window closed, checking status...');
              checkAuthStatus();
            }
          } catch (error) {
            console.log('Auth window check error:', error);
          }
        }, 1000);
        
        // Also listen for messages from the auth window
        const messageHandler = (event) => {
          if (event.origin !== window.location.origin && event.data.type === 'figma-auth-success') {
            console.log('Auth success message received');
            clearInterval(checkAuth);
            authWindow.close();
            window.removeEventListener('message', messageHandler);
            checkAuthStatus();
          }
        };
        
        window.addEventListener('message', messageHandler);
        
        // Clean up after 5 minutes
        setTimeout(() => {
          clearInterval(checkAuth);
          window.removeEventListener('message', messageHandler);
        }, 300000);
        
      } catch (error) {
        console.error('Auth error:', error);
        showMessage('❌ API not accessible. Please deploy the API first: npx vercel --prod', 'error');
      }
    });

    // Test authentication (debug)
    document.getElementById('test-auth-button').addEventListener('click', () => {
      console.log('=== AUTH DEBUG INFO ===');
      console.log('API_BASE:', API_BASE);
      console.log('Current userSession:', userSession);
      console.log('localStorage buddySession:', localStorage.getItem('buddySession'));
      console.log('Auth URL would be:', `${API_BASE}/api/auth?action=figma-oauth`);
      
      // Test if we can reach the API
      fetch(`${API_BASE}/api/auth?action=figma-oauth`)
        .then(response => {
          console.log('Auth endpoint response status:', response.status);
          return response.text();
        })
        .then(text => {
          console.log('Auth endpoint response:', text.substring(0, 200) + '...');
        })
        .catch(error => {
          console.error('Auth endpoint error:', error);
        });
      
      showMessage('Check console for debug info', 'success');
    });

    // Load user context
    async function loadUserContext() {
      if (!userSession) return;
      
      try {
        const response = await fetch(`${API_BASE}/api/user?action=context`, {
          headers: {
            'Authorization': `Bearer ${btoa(JSON.stringify(userSession))}`
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          userContext = data.context;
          
          // Apply context to form
          if (userContext.product_context) {
            document.getElementById('context').value = userContext.product_context;
            updateContextCount();
          }
          
          if (userContext.analysis_settings) {
            const settings = userContext.analysis_settings;
            document.getElementById('length').value = settings.length || 'detailed';
            document.getElementById('tone').value = settings.tone || 'professional';
            
            // Apply focus areas
            const focusCheckboxes = document.querySelectorAll('input[type="checkbox"]');
            focusCheckboxes.forEach(checkbox => {
              checkbox.checked = settings.focus_areas && settings.focus_areas.includes(checkbox.value);
            });
          }
        }
      } catch (error) {
        console.error('Failed to load user context:', error);
      }
    }

    // Check webhook status
    async function checkWebhookStatus() {
      if (!userSession) return;
      
      try {
        const response = await fetch(`${API_BASE}/api/user?action=webhooks`, {
          headers: {
            'Authorization': `Bearer ${btoa(JSON.stringify(userSession))}`
          }
        });
        
        if (response.ok) {
          const data = await response.json();
          const webhookStatus = document.getElementById('webhook-status-text');
          
          if (data.webhooks && data.webhooks.length > 0) {
            webhookStatus.textContent = 'Active';
            webhookStatus.style.color = '#00AA44';
          } else {
            webhookStatus.textContent = 'Not configured';
            webhookStatus.style.color = '#ff6b6b';
          }
        }
      } catch (error) {
        console.error('Failed to check webhook status:', error);
        document.getElementById('webhook-status-text').textContent = 'Error';
        document.getElementById('webhook-status-text').style.color = '#ff6b6b';
      }
    }

    // Show message
    function showMessage(text, type = 'success') {
      const statusDiv = document.getElementById('status');
      statusDiv.innerHTML = `<div class="message ${type}">${text}</div>`;
      setTimeout(() => {
        statusDiv.innerHTML = '';
      }, 5000);
    }

    // Load settings from localStorage
    function loadSettings() {
      const saved = localStorage.getItem('buddySettings');
      if (saved) {
        currentSettings = JSON.parse(saved);
        
        // Apply settings to form
        document.getElementById('length').value = currentSettings.length || 'detailed';
        document.getElementById('tone').value = currentSettings.tone || 'professional';
        
        // Apply context
        if (currentSettings.context) {
          document.getElementById('context').value = currentSettings.context;
          updateContextCount();
        }
        
        // Apply focus areas
        const focusCheckboxes = document.querySelectorAll('input[type="checkbox"]');
        focusCheckboxes.forEach(checkbox => {
          checkbox.checked = currentSettings.focus && currentSettings.focus.includes(checkbox.value);
        });
      }
    }

    // Save settings
    async function saveSettings() {
      const settings = {
        length: document.getElementById('length').value,
        tone: document.getElementById('tone').value,
        context: document.getElementById('context').value,
        focus: Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value)
      };
      
      // Save locally
      localStorage.setItem('buddySettings', JSON.stringify(settings));
      currentSettings = settings;
      
      // Save to server if authenticated
      if (userSession) {
        await saveUserContext(settings);
      }
    }

    // Save user context to server
    async function saveUserContext(settings) {
      try {
        const contextData = {
          product_context: settings.context,
          analysis_settings: {
            length: settings.length,
            tone: settings.tone,
            focus_areas: settings.focus,
            include_visual: document.getElementById('include-visual').checked
          }
        };

            const response = await fetch(`${API_BASE}/api/user?action=context`, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${btoa(JSON.stringify(userSession))}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(contextData)
            });

        if (response.ok) {
          console.log('Context saved to server');
        }
      } catch (error) {
        console.error('Failed to save context to server:', error);
      }
    }

    // Setup webhook
    document.getElementById('setup-webhook-btn').addEventListener('click', async () => {
      if (!userSession) return;
      
      try {
        // Get team ID (simplified - in production, let user select team)
        const teamId = userSession.team_id || 'default-team';
        const webhookUrl = `${API_BASE}/api/figma-comment-webhook`;
        
            const response = await fetch(`${API_BASE}/api/user?action=webhooks`, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${btoa(JSON.stringify(userSession))}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                team_id: teamId,
                webhook_url: webhookUrl
              })
            });

        if (response.ok) {
          showMessage('Webhook setup successfully!', 'success');
          await checkWebhookStatus();
        } else {
          const error = await response.json();
          showMessage('Failed to setup webhook: ' + error.error, 'error');
        }
      } catch (error) {
        showMessage('Failed to setup webhook: ' + error.message, 'error');
      }
    });

    // Delete webhook
    document.getElementById('delete-webhook-btn').addEventListener('click', async () => {
      if (!userSession) return;
      
      try {
            const response = await fetch(`${API_BASE}/api/user?action=webhooks`, {
              method: 'DELETE',
              headers: {
                'Authorization': `Bearer ${btoa(JSON.stringify(userSession))}`,
                'Content-Type': 'application/json'
              }
            });

        if (response.ok) {
          showMessage('Webhook deleted successfully!', 'success');
          await checkWebhookStatus();
        } else {
          const error = await response.json();
          showMessage('Failed to delete webhook: ' + error.error, 'error');
        }
      } catch (error) {
        showMessage('Failed to delete webhook: ' + error.message, 'error');
      }
    });

    // Update context word count
    function updateContextCount() {
      const contextText = document.getElementById('context').value;
      const wordCount = contextText.trim() ? contextText.trim().split(/\s+/).length : 0;
      const countElement = document.getElementById('context-count');
      
      countElement.textContent = `${wordCount}/1000 words`;
      
      if (wordCount > 1000) {
        countElement.className = 'context-count error';
      } else if (wordCount > 800) {
        countElement.className = 'context-count warning';
      } else {
        countElement.className = 'context-count';
      }
    }

    // Add context input event listener
    document.getElementById('context').addEventListener('input', updateContextCount);

    // Handle save settings button
    document.getElementById('save-settings-btn').addEventListener('click', async () => {
      // Check context word limit
      const contextText = document.getElementById('context').value;
      const wordCount = contextText.trim() ? contextText.trim().split(/\s+/).length : 0;
      if (wordCount > 1000) {
        showMessage('Context cannot exceed 1000 words. Please reduce the text.', 'error');
        return;
      }

      // Save current settings
      await saveSettings();
      showMessage('Settings saved successfully!', 'success');
    });


    // Close plugin
    function closePlugin() {
      parent.postMessage({
        pluginMessage: {
          type: 'close-plugin'
        }
      }, '*');
    }

    // Handle messages from plugin code
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      
      switch (msg.type) {
        case 'plugin-ready':
          initPlugin();
          break;
          
        case 'error':
          showMessage(msg.message, 'error');
          break;
      }
    };

    // Initialize on load
    document.addEventListener('DOMContentLoaded', initPlugin);
  </script>
</body>
</html>
